-- ==============================================================================
--                                  CÀI ĐẶT CHUNG
-- ==============================================================================
if getgenv().Toggle_G == nil then getgenv().Toggle_G = false end
if getgenv().Toggle_H == nil then getgenv().Toggle_H = false end

getgenv().Creator = 'Andeptrai'

local UserInputService = game:GetService("UserInputService")
local GuiService = game:GetService("GuiService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService") 
local LocalPlayer = Players.LocalPlayer
local moveTime = 0.3 -- Tốc độ dịch chuyển (càng nhỏ bay càng nhanh)

-- === CẤU HÌNH THỜI GIAN & PHẠM VI ===
local SKILL_DELAY = 3.0   -- Thời gian chờ trước khi đánh
local TOOL_NAME = "Spinning Lariat" 
local SEARCH_RADIUS = 60  -- Bán kính tìm quái (Tránh Boss ở xa)

local isTeleportingActive = false 
local LastMobName = nil           

-- Biến lưu trữ UI & Vị trí
local MainFrame, StatusLabel_G, StatusLabel_H, UIStroke
if not getgenv().Ann_LastUIPos then getgenv().Ann_LastUIPos = nil end

local isDragging, dragInput, dragStart, startPos
local Mouse = LocalPlayer:GetMouse() 

-- ==============================================================================
--                        CHỨC NĂNG 1: AUTO NEXT STAGE (PHÍM H)
-- ==============================================================================
local function pressButtonViaKeyboard(button)
    if not button or not button.Visible then return end
    GuiService.SelectedObject = button; task.wait(0.1)
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Return, false, game); task.wait(0.05)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Return, false, game); task.wait(0.1)
    GuiService.SelectedObject = nil
end

task.spawn(function()
    while true do
        task.wait(1) 
        if getgenv().Toggle_H then 
            local playerGui = LocalPlayer:FindFirstChild("PlayerGui")
            if playerGui then
                pcall(function()
                    local backBtn = playerGui.TrialResult.Frame.Container.Back.Back.Button
                    if backBtn and backBtn.Visible then pressButtonViaKeyboard(backBtn) end
                end)
                pcall(function()
                    local startFrame = playerGui.TrialUI.Frame.Container.Container.Right.Start
                    local startBtn = startFrame:FindFirstChild("Button") or startFrame:FindFirstChild("TextButton")
                    if startBtn and startBtn.Visible then pressButtonViaKeyboard(startBtn) end
                end)
            end
        end
    end
end)

-- ==============================================================================
--                        CHỨC NĂNG 2: AUTO FARM (PHÍM G)
-- ==============================================================================
local function activateSpinningLariat()
    local character = LocalPlayer.Character
    local humanoid = character and character:FindFirstChild("Humanoid")
    local backpack = LocalPlayer:FindFirstChild("Backpack")
    if not humanoid then return end

    local tool = character:FindFirstChild(TOOL_NAME) 
    if not tool then
        if backpack then
            local toolInBackpack = backpack:FindFirstChild(TOOL_NAME)
            if toolInBackpack then
                humanoid:EquipTool(toolInBackpack); task.wait() 
                tool = character:FindFirstChild(TOOL_NAME) 
            end
        end
    end
    if tool and tool:IsA("Tool") then tool:Activate() end
end

local function runKillAura()
    sethiddenproperty(LocalPlayer, "SimulationRadius", 112412400000)
    sethiddenproperty(LocalPlayer, "MaxSimulationRadius", 112412400000)
    for _, d in pairs(game.Workspace:GetDescendants()) do
        if d.ClassName == 'Humanoid' and d.Parent.Name ~= LocalPlayer.Name then d.Health = 0 end
    end
end

-- === HÀM DỊCH CHUYỂN (GIỮ NGUYÊN) ===
local function tweenBehind(npc)
    local character = LocalPlayer.Character
    if not character then return end
    local root = character:FindFirstChild("HumanoidRootPart")
    local enemyRoot = npc and npc:FindFirstChild("HumanoidRootPart")
    if not root or not enemyRoot then return end
    
    -- Tính toán vị trí sau lưng quái
    local targetCFrame = enemyRoot.CFrame * CFrame.new(0, 0, 2) 
    
    -- Thực hiện bay (Tween) đến vị trí đó
    local tween = TweenService:Create(root, TweenInfo.new(moveTime, Enum.EasingStyle.Circular, Enum.EasingDirection.Out), {CFrame = targetCFrame})
    tween:Play()
end

local function getNearestMob()
    local nearest = nil
    local shortest = math.huge
    local character = LocalPlayer.Character
    if not character then return nil end
    local root = character:FindFirstChild("HumanoidRootPart")
    if not root then return nil end
    
    local mobContainer = workspace:FindFirstChild("Mobs")
    if not mobContainer then return nil end

    for _, mob in pairs(mobContainer:GetChildren()) do
        local mobRoot = mob:FindFirstChild("HumanoidRootPart")
        local mobHum = mob:FindFirstChild("Humanoid")
        
        if mobRoot and mobHum and mobHum.Health > 0 and mob.Name ~= LocalPlayer.Name then 
            local dist = (mobRoot.Position - root.Position).Magnitude
            
            -- Chỉ lấy quái trong bán kính 60 để tránh Boss
            if dist < shortest and dist <= SEARCH_RADIUS then
                shortest = dist
                nearest = mob
            end
        end
    end
    return nearest
end

-- ==============================================================================
--                                  GIAO DIỆN UI
-- ==============================================================================
local function updateInput(input)
    local delta = input.Position - dragStart
    MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

local function makeDraggable(frame)
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            isDragging = true; dragStart = input.Position; startPos = frame.Position
            input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then isDragging = false end end)
        end
    end)
    frame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then dragInput = input end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and isDragging then updateInput(input) end
    end)
end

local function CreateToggleUI()
    if LocalPlayer:FindFirstChild("PlayerGui") and LocalPlayer.PlayerGui:FindFirstChild("Ann_ToggleUI") then 
        LocalPlayer.PlayerGui.Ann_ToggleUI:Destroy() 
    end

    local ScreenGui = Instance.new("ScreenGui", LocalPlayer.PlayerGui)
    ScreenGui.Name = "Ann_ToggleUI"

    MainFrame = Instance.new("Frame", ScreenGui)
    MainFrame.Name = "MainFrame"
    MainFrame.Size = UDim2.new(0, 260, 0, 90) 
    if getgenv().Ann_LastUIPos then MainFrame.Position = getgenv().Ann_LastUIPos else MainFrame.Position = UDim2.new(0.5, -130, 0.5, -100) end
    MainFrame:GetPropertyChangedSignal("Position"):Connect(function() getgenv().Ann_LastUIPos = MainFrame.Position end)
    MainFrame.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1); MainFrame.BackgroundTransparency = 0.1
    Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 8)
    
    UIStroke = Instance.new("UIStroke", MainFrame); UIStroke.Thickness = 2
    UIStroke.Color = getgenv().Toggle_G and Color3.new(0, 1, 0) or Color3.new(1, 0, 0)

    local Title = Instance.new("TextLabel", MainFrame)
    Title.Text = "Made by Ann"; Title.Size = UDim2.new(1, 0, 0.4, 0); Title.BackgroundTransparency = 1
    Title.TextColor3 = Color3.new(1, 1, 1); Title.Font = Enum.Font.FredokaOne; Title.TextSize = 20

    StatusLabel_G = Instance.new("TextLabel", MainFrame)
    StatusLabel_G.Size = UDim2.new(1, 0, 0.3, 0); StatusLabel_G.Position = UDim2.new(0, 0, 0.4, 0)
    StatusLabel_G.BackgroundTransparency = 1; StatusLabel_G.Font = Enum.Font.SourceSansBold; StatusLabel_G.TextSize = 16
    StatusLabel_G.Text = "[G] Auto Farm: " .. (getgenv().Toggle_G and "ON" or "OFF")
    StatusLabel_G.TextColor3 = getgenv().Toggle_G and Color3.new(0, 1, 0) or Color3.new(1, 0, 0)

    StatusLabel_H = Instance.new("TextLabel", MainFrame)
    StatusLabel_H.Size = UDim2.new(1, 0, 0.3, 0); StatusLabel_H.Position = UDim2.new(0, 0, 0.7, 0)
    StatusLabel_H.BackgroundTransparency = 1; StatusLabel_H.Font = Enum.Font.SourceSansBold; StatusLabel_H.TextSize = 16
    StatusLabel_H.Text = "[H] Auto Next Stage: " .. (getgenv().Toggle_H and "ON" or "OFF")
    StatusLabel_H.TextColor3 = getgenv().Toggle_H and Color3.new(0, 1, 0) or Color3.new(1, 0, 0)

    makeDraggable(MainFrame)
end
LocalPlayer.CharacterAdded:Connect(function() task.wait(1); CreateToggleUI() end); CreateToggleUI()

UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.G then
        getgenv().Toggle_G = not getgenv().Toggle_G
        local col = getgenv().Toggle_G and Color3.new(0, 1, 0) or Color3.new(1, 0, 0)
        if StatusLabel_G then StatusLabel_G.Text = "[G] Auto Farm: " .. (getgenv().Toggle_G and "ON" or "OFF"); StatusLabel_G.TextColor3 = col end
        if UIStroke then UIStroke.Color = col end
    end
    if input.KeyCode == Enum.KeyCode.H then
        getgenv().Toggle_H = not getgenv().Toggle_H
        local col = getgenv().Toggle_H and Color3.new(0, 1, 0) or Color3.new(1, 0, 0)
        if StatusLabel_H then StatusLabel_H.Text = "[H] Auto Next Stage: " .. (getgenv().Toggle_H and "ON" or "OFF"); StatusLabel_H.TextColor3 = col end
    end
end)

-- ==============================================================================
--                            VÒNG LẶP FARM
-- ==============================================================================
while task.wait(0.2) do
    if getgenv().Toggle_G then
        runKillAura()
        
        if isTeleportingActive then
            -- Vẫn dịch chuyển bám theo quái
            local mob = getNearestMob()
            if mob and mob.Name == LastMobName then
                tweenBehind(mob)
            else
                isTeleportingActive = false
                LastMobName = nil
            end
        else
            local mob = getNearestMob()
            if mob and mob.Name ~= LastMobName then
                -- Kích hoạt dịch chuyển đến quái mới tìm được
                isTeleportingActive = true
                tweenBehind(mob) 
                LastMobName = mob.Name 
                
                task.spawn(function()
                    local targetMob = mob 
                    
                    -- Chờ 3s
                    local startTime = tick()
                    while tick() - startTime < SKILL_DELAY do
                        if not isTeleportingActive or not getgenv().Toggle_G then return end
                        if not targetMob or not targetMob.Parent or not targetMob:FindFirstChild("Humanoid") or targetMob.Humanoid.Health <= 0 then
                            isTeleportingActive = false
                            LastMobName = nil
                            return 
                        end
                        tweenBehind(targetMob) 
                        task.wait(0.1)
                    end

                    -- Spam đánh
                    while targetMob and targetMob.Parent and targetMob:FindFirstChild("Humanoid") and targetMob.Humanoid.Health > 0 do
                        if not isTeleportingActive or not getgenv().Toggle_G then break end
                        activateSpinningLariat() 
                        tweenBehind(targetMob)   
                        task.wait(0.1) 
                    end
                    
                    isTeleportingActive = false 
                    LastMobName = nil
                end)
            end
        end
    end
end
