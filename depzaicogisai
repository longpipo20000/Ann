-- ==============================================================================
--                          CÀI ĐẶT CHUNG & ANTI-CRASH
-- ==============================================================================
if getgenv().Toggle_G == nil then getgenv().Toggle_G = false end
if getgenv().Toggle_H == nil then getgenv().Toggle_H = false end

getgenv().Creator = 'Andeptrai'

-- [ANTI-CRASH] Tối ưu hóa FPS và Ram để treo lâu không bị văng
local RunService = game:GetService("RunService")
if setfpscap then setfpscap(60) end -- Giới hạn 30 FPS để nhẹ máy
game:GetService("Lighting").GlobalShadows = false
game:GetService("Lighting").FogEnd = 9e9
settings().Rendering.QualityLevel = "Level01"

local UserInputService = game:GetService("UserInputService")
local GuiService = game:GetService("GuiService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer
local moveTime = 0

-- === CẤU HÌNH THỜI GIAN ===
local SKILL_DELAY = 3.0     -- Chờ 3s
local SPAM_DURATION = 3.0   -- Spam 3s
local STOP_MOVE_TIME = 3.5  -- Dừng bay sau 3.5s

local TOOL_NAME = "Spinning Lariat" 
local SEARCH_RADIUS = 1000 

local isTeleportingActive = false 
local LastMobName = nil   
local AttackStartTime = 0 
local activeTween = nil -- [FIX CRASH] Biến lưu tween hiện tại

-- Biến UI
local MainFrame, StatusLabel_G, StatusLabel_H, UIStroke
if not getgenv().Ann_LastUIPos then getgenv().Ann_LastUIPos = nil end
local isDragging, dragInput, dragStart, startPos
local Mouse = LocalPlayer:GetMouse() 

-- ==============================================================================
--                        CHỨC NĂNG 1: AUTO NEXT STAGE (PHÍM H)
-- ==============================================================================
local function pressButtonViaKeyboard(button)
    if not button or not button.Visible then return end
    GuiService.SelectedObject = button
    task.wait(0.1)
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
    task.wait(0.05)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
    task.wait(0.1)
    GuiService.SelectedObject = nil
end

task.spawn(function()
    while true do
        task.wait(1) 
        if getgenv().Toggle_H then 
            local playerGui = LocalPlayer:FindFirstChild("PlayerGui")
            if playerGui then
                pcall(function()
                    local backBtn = playerGui.TrialResult.Frame.Container.Back.Back.Button
                    if backBtn and backBtn.Visible then pressButtonViaKeyboard(backBtn) end
                end)
                pcall(function()
                    local startFrame = playerGui.TrialUI.Frame.Container.Container.Right.Start
                    local startBtn = startFrame:FindFirstChild("Button") or startFrame:FindFirstChild("TextButton")
                    if startBtn and startBtn.Visible then pressButtonViaKeyboard(startBtn) end
                end)
            end
        end
    end
end)

-- ==============================================================================
--                        CHỨC NĂNG 2: AUTO FARM (TỐI ƯU HÓA)
-- ==============================================================================
local function activateSpinningLariat()
    local character = LocalPlayer.Character
    local humanoid = character and character:FindFirstChild("Humanoid")
    local backpack = LocalPlayer:FindFirstChild("Backpack")

    if not humanoid then return end

    local tool = character:FindFirstChild(TOOL_NAME) 
    
    -- [FIX CRASH] Chỉ tìm trong Balo nếu trên tay không có
    if not tool then
        if backpack then
            local toolInBackpack = backpack:FindFirstChild(TOOL_NAME)
            if toolInBackpack then
                humanoid:EquipTool(toolInBackpack)
                -- Không dùng task.wait ở đây để tránh delay loop
            end
        end
        -- Cập nhật lại biến tool sau khi equip
        tool = character:FindFirstChild(TOOL_NAME)
    end

    if tool and tool:IsA("Tool") then
        tool:Activate()
    end
end

local function runKillAura()
    -- [FIX CRASH] Giảm tần suất set simulation để đỡ lag physics
    sethiddenproperty(LocalPlayer, "SimulationRadius", 112412400000)
    sethiddenproperty(LocalPlayer, "MaxSimulationRadius", 112412400000)
    for _, d in pairs(game.Workspace:GetDescendants()) do
        if d.ClassName == 'Humanoid' and d.Parent.Name ~= LocalPlayer.Name then
            d.Health = 0
        end
    end
end

-- [FIX CRASH] Hàm Tween thông minh: Hủy tween cũ trước khi tạo mới
local function tweenBehind(npc)
    local character = LocalPlayer.Character
    if not character then return end
    local root = character:FindFirstChild("HumanoidRootPart")
    local enemyRoot = npc:FindFirstChild("HumanoidRootPart")
    if not root or not enemyRoot then return end
    
    local targetCFrame = enemyRoot.CFrame * CFrame.new(0, 0, 0) -- Bay ra sau lưng 2 studs cho an toàn
    
    -- Nếu khoảng cách quá gần (< 2 studs) thì không cần Tween để đỡ tốn Ram
    if (root.Position - targetCFrame.Position).Magnitude < 2 then
        return
    end

    -- Hủy tween cũ nếu đang chạy
    if activeTween then
        activeTween:Cancel()
        activeTween = nil
    end
    
    local tweenInfo = TweenInfo.new(moveTime, Enum.EasingStyle.Linear, Enum.EasingDirection.Out)
    activeTween = TweenService:Create(root, tweenInfo, {CFrame = targetCFrame})
    activeTween:Play()
    
    -- Dọn dẹp biến khi xong
    activeTween.Completed:Connect(function()
        activeTween = nil
    end)
end

local function getNearestMob()
    local nearest = nil
    local shortest = math.huge
    local character = LocalPlayer.Character
    if not character then return nil end
    local root = character:FindFirstChild("HumanoidRootPart")
    if not root then return nil end
    
    local mobContainer = workspace:FindFirstChild("Mobs")
    if not mobContainer then return nil end

    for _, mob in pairs(mobContainer:GetChildren()) do
        local mobRoot = mob:FindFirstChild("HumanoidRootPart")
        if mobRoot and mob.Name ~= LocalPlayer.Name then 
            local dist = (mobRoot.Position - root.Position).Magnitude
            if dist < shortest and dist <= SEARCH_RADIUS then
                shortest = dist
                nearest = mob
            end
        end
    end
    return nearest
end

-- ==============================================================================
--                                  GIAO DIỆN UI
-- ==============================================================================
local function updateInput(input)
    local delta = input.Position - dragStart
    MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

local function makeDraggable(frame)
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            isDragging = true; dragStart = input.Position; startPos = frame.Position
            input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then isDragging = false end end)
        end
    end)
    frame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then dragInput = input end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and isDragging then updateInput(input) end
    end)
end

local function CreateToggleUI()
    if LocalPlayer:FindFirstChild("PlayerGui") and LocalPlayer.PlayerGui:FindFirstChild("Ann_ToggleUI") then 
        LocalPlayer.PlayerGui.Ann_ToggleUI:Destroy() 
    end

    local ScreenGui = Instance.new("ScreenGui", LocalPlayer.PlayerGui)
    ScreenGui.Name = "Ann_ToggleUI"

    MainFrame = Instance.new("Frame", ScreenGui)
    MainFrame.Name = "MainFrame"
    MainFrame.Size = UDim2.new(0, 260, 0, 90) 
    if getgenv().Ann_LastUIPos then MainFrame.Position = getgenv().Ann_LastUIPos else MainFrame.Position = UDim2.new(0.5, -130, 0.5, -100) end
    MainFrame:GetPropertyChangedSignal("Position"):Connect(function() getgenv().Ann_LastUIPos = MainFrame.Position end)
    MainFrame.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1); MainFrame.BackgroundTransparency = 0.1
    Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 8)
    
    UIStroke = Instance.new("UIStroke", MainFrame); UIStroke.Thickness = 2
    UIStroke.Color = getgenv().Toggle_G and Color3.new(0, 1, 0) or Color3.new(1, 0, 0)

    local Title = Instance.new("TextLabel", MainFrame)
    Title.Text = "Made by Ann"; Title.Size = UDim2.new(1, 0, 0.4, 0); Title.BackgroundTransparency = 1
    Title.TextColor3 = Color3.new(1, 1, 1); Title.Font = Enum.Font.FredokaOne; Title.TextSize = 20

    StatusLabel_G = Instance.new("TextLabel", MainFrame)
    StatusLabel_G.Size = UDim2.new(1, 0, 0.3, 0); StatusLabel_G.Position = UDim2.new(0, 0, 0.4, 0)
    StatusLabel_G.BackgroundTransparency = 1; StatusLabel_G.Font = Enum.Font.SourceSansBold; StatusLabel_G.TextSize = 16
    StatusLabel_G.Text = "[G] Auto Farm: " .. (getgenv().Toggle_G and "ON" or "OFF")
    StatusLabel_G.TextColor3 = getgenv().Toggle_G and Color3.new(0, 1, 0) or Color3.new(1, 0, 0)

    StatusLabel_H = Instance.new("TextLabel", MainFrame)
    StatusLabel_H.Size = UDim2.new(1, 0, 0.3, 0); StatusLabel_H.Position = UDim2.new(0, 0, 0.7, 0)
    StatusLabel_H.BackgroundTransparency = 1; StatusLabel_H.Font = Enum.Font.SourceSansBold; StatusLabel_H.TextSize = 16
    StatusLabel_H.Text = "[H] Auto Next Stage: " .. (getgenv().Toggle_H and "ON" or "OFF")
    StatusLabel_H.TextColor3 = getgenv().Toggle_H and Color3.new(0, 1, 0) or Color3.new(1, 0, 0)

    makeDraggable(MainFrame)
end
LocalPlayer.CharacterAdded:Connect(function() task.wait(1); CreateToggleUI() end); CreateToggleUI()

UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.G then
        getgenv().Toggle_G = not getgenv().Toggle_G
        local col = getgenv().Toggle_G and Color3.new(0, 1, 0) or Color3.new(1, 0, 0)
        if StatusLabel_G then StatusLabel_G.Text = "[G] Auto Farm: " .. (getgenv().Toggle_G and "ON" or "OFF"); StatusLabel_G.TextColor3 = col end
        if UIStroke then UIStroke.Color = col end
    end
    if input.KeyCode == Enum.KeyCode.H then
        getgenv().Toggle_H = not getgenv().Toggle_H
        local col = getgenv().Toggle_H and Color3.new(0, 1, 0) or Color3.new(1, 0, 0)
        if StatusLabel_H then StatusLabel_H.Text = "[H] Auto Next Stage: " .. (getgenv().Toggle_H and "ON" or "OFF"); StatusLabel_H.TextColor3 = col end
    end
end)

-- ==============================================================================
--                            VÒNG LẶP FARM
-- ==============================================================================
while task.wait(0.2) do
    if getgenv().Toggle_G then
        runKillAura()
        
        -- Logic di chuyển cơ bản khi không trong trạng thái tấn công
        if isTeleportingActive then
            local mob = getNearestMob()
            if mob and mob.Name == LastMobName then
                -- [CHECK MỚI] Chỉ dịch chuyển nếu thời gian trôi qua < 3.5 giây
                if tick() - AttackStartTime < STOP_MOVE_TIME then
                    tweenBehind(mob)
                end
            else
                isTeleportingActive = false
                LastMobName = nil
                if activeTween then activeTween:Cancel() end -- Dọn dẹp tween
            end
        else
            local mob = getNearestMob()
            if mob and mob.Name ~= LastMobName then
                isTeleportingActive = true
                tweenBehind(mob)
                LastMobName = mob.Name 
                AttackStartTime = tick() 
                
                task.spawn(function()
                    local startTime = AttackStartTime
                    
                    -- === Giai đoạn 1: CHỜ 3 GIÂY ===
                    while tick() - startTime < SKILL_DELAY do
                        if not isTeleportingActive or not getgenv().Toggle_G then return end
                        
                        -- Vẫn cho phép di chuyển trong giai đoạn chờ này (vì < 3.5s)
                        if tick() - startTime < STOP_MOVE_TIME then
                             local currentMob = getNearestMob()
                             if currentMob then tweenBehind(currentMob) end
                        end
                        
                        task.wait(0.1)
                    end

                    -- === Giai đoạn 2: SPAM CHIÊU TRONG 3 GIÂY ===
                    local spamStart = tick()
                    while tick() - spamStart < SPAM_DURATION do
                        if not isTeleportingActive or not getgenv().Toggle_G then break end
                        
                        activateSpinningLariat()
                        
                        -- Kiểm tra: Chỉ di chuyển thêm 0.5s đầu của giai đoạn này
                        if tick() - startTime < STOP_MOVE_TIME then
                            local currentMob = getNearestMob()
                            if currentMob then tweenBehind(currentMob) end
                        else
                            -- Hủy tween nếu còn sót để đứng yên hoàn toàn
                            if activeTween then activeTween:Cancel(); activeTween = nil end
                        end
                        
                        task.wait(0.1) 
                    end
                    
                    isTeleportingActive = false 
                end)
            end
        end
    end
end
