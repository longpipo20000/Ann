-- ==============================================================================
--                                  CÀI ĐẶT CHUNG
-- ==============================================================================
-- Giữ trạng thái Bật/Tắt nếu script chạy lại
if getgenv().Toggle_G == nil then getgenv().Toggle_G = false end
if getgenv().Toggle_H == nil then getgenv().Toggle_H = false end

getgenv().Creator = 'Andeptrai'

local UserInputService = game:GetService("UserInputService")
local GuiService = game:GetService("GuiService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService") 
local LocalPlayer = Players.LocalPlayer
local moveTime = 0.3

-- CẤU HÌNH THỜI GIAN (GIỮ NGUYÊN NHƯ BẠN YÊU CẦU)
local RUN_DURATION = 4.0  
local SKILL_DELAY = 3.0   
local TOOL_NAME = "Spinning Lariat" 

local isTeleportingActive = false 
local LastMobName = nil           

-- Biến lưu trữ UI & Vị trí (Dùng biến global tạm để không mất khi reset)
local MainFrame, StatusLabel_G, StatusLabel_H, UIStroke
-- Sử dụng getgenv để lưu vị trí, đảm bảo không mất dù có chuyện gì xảy ra
if not getgenv().Ann_LastUIPos then getgenv().Ann_LastUIPos = nil end

local isDragging, dragInput, dragStart, startPos
local Mouse = LocalPlayer:GetMouse() 

-- ==============================================================================
--                        CHỨC NĂNG 1: AUTO NEXT STAGE (PHÍM H)
-- ==============================================================================
local function pressButtonViaKeyboard(button)
    if not button or not button.Visible then return end
    
    GuiService.SelectedObject = button
    task.wait(0.1)
    
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
    task.wait(0.05)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
    
    task.wait(0.1)
    GuiService.SelectedObject = nil
end

task.spawn(function()
    while true do
        task.wait(1) 
        
        if getgenv().Toggle_H then 
            local playerGui = LocalPlayer:FindFirstChild("PlayerGui")
            if playerGui then
                pcall(function()
                    local backBtn = playerGui.TrialResult.Frame.Container.Back.Back.Button
                    if backBtn and backBtn.Visible then
                        pressButtonViaKeyboard(backBtn)
                    end
                end)

                pcall(function()
                    local startFrame = playerGui.TrialUI.Frame.Container.Container.Right.Start
                    local startBtn = startFrame:FindFirstChild("Button") or startFrame:FindFirstChild("TextButton")
                    
                    if startBtn and startBtn.Visible then
                        pressButtonViaKeyboard(startBtn)
                    end
                end)
            end
        end
    end
end)

-- ==============================================================================
--                        CHỨC NĂNG 2: AUTO FARM (PHÍM G)
-- ==============================================================================
local function activateSpinningLariat()
    local character = LocalPlayer.Character
    local humanoid = character and character:FindFirstChild("Humanoid")
    local backpack = LocalPlayer:FindFirstChild("Backpack")

    if not humanoid then return end

    local tool = character:FindFirstChild(TOOL_NAME) 

    if not tool or not tool:IsA("Tool") then
        if backpack then
            local toolInBackpack = backpack:FindFirstChild(TOOL_NAME)
            if toolInBackpack and toolInBackpack:IsA("Tool") then
                humanoid:EquipTool(toolInBackpack)
                task.wait(0.1) 
                tool = character:FindFirstChild(TOOL_NAME) 
            end
        end
    end

    if tool and tool:IsA("Tool") then
        for i = 1, 5 do
            tool:Activate() 
            task.wait(0.05)
        end
    end
end

local function runKillAura()
    sethiddenproperty(LocalPlayer, "SimulationRadius", 112412400000)
    sethiddenproperty(LocalPlayer, "MaxSimulationRadius", 112412400000)
    for _, d in pairs(game.Workspace:GetDescendants()) do
        if d.ClassName == 'Humanoid' and d.Parent.Name ~= LocalPlayer.Name then
            d.Health = 0
        end
    end
end

local function tweenBehind(npc)
    local character = LocalPlayer.Character
    if not character then return end
    local root = character:FindFirstChild("HumanoidRootPart")
    local enemyRoot = npc:FindFirstChild("HumanoidRootPart")
    if not root or not enemyRoot then return end
    
    local targetCFrame = enemyRoot.CFrame * CFrame.new(0, 0, 2) 
    local tween = TweenService:Create(root, TweenInfo.new(moveTime, Enum.EasingStyle.Circular, Enum.EasingDirection.Out), {CFrame = targetCFrame})
    tween:Play()
end

local function getNearestMob()
    local nearest = nil
    local shortest = math.huge
    local character = LocalPlayer.Character
    if not character then return nil end
    local root = character:FindFirstChild("HumanoidRootPart")
    if not root then return nil end
    
    local mobContainer = workspace:FindFirstChild("Mobs")
    if not mobContainer then return nil end

    for _, mob in pairs(mobContainer:GetChildren()) do
        local mobRoot = mob:FindFirstChild("HumanoidRootPart")
        if mobRoot and mob.Name ~= LocalPlayer.Name then 
            local dist = (mobRoot.Position - root.Position).Magnitude
            if dist < shortest then
                shortest = dist
                nearest = mob
            end
        end
    end
    return nearest
end

-- ==============================================================================
--                                  GIAO DIỆN UI (ĐÃ SỬA LỖI VỊ TRÍ)
-- ==============================================================================

local function updateInput(input)
    local delta = input.Position - dragStart
    MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

local function makeDraggable(frame)
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            isDragging = true
            dragStart = input.Position
            startPos = frame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    isDragging = false
                end
            end)
        end
    end)
    
    frame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and isDragging then
            updateInput(input)
        end
    end)
end

local function CreateToggleUI()
    if LocalPlayer:FindFirstChild("PlayerGui") and LocalPlayer.PlayerGui:FindFirstChild("Ann_ToggleUI") then 
        LocalPlayer.PlayerGui.Ann_ToggleUI:Destroy() 
    end

    local ScreenGui = Instance.new("ScreenGui", LocalPlayer.PlayerGui)
    ScreenGui.Name = "Ann_ToggleUI"

    MainFrame = Instance.new("Frame", ScreenGui)
    MainFrame.Name = "MainFrame"
    MainFrame.Size = UDim2.new(0, 260, 0, 90) 
    
    -- FIX: Sử dụng vị trí đã lưu (getgenv)
    if getgenv().Ann_LastUIPos then 
        MainFrame.Position = getgenv().Ann_LastUIPos 
    else 
        MainFrame.Position = UDim2.new(0.5, -130, 0.5, -100) 
    end
    
    -- FIX: Luôn cập nhật vị trí mới nhất khi khung di chuyển
    MainFrame:GetPropertyChangedSignal("Position"):Connect(function() 
        getgenv().Ann_LastUIPos = MainFrame.Position 
    end)

    MainFrame.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
    MainFrame.BackgroundTransparency = 0.1
    Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 8)
    
    UIStroke = Instance.new("UIStroke", MainFrame)
    UIStroke.Thickness = 2
    UIStroke.Color = getgenv().Toggle_G and Color3.new(0, 1, 0) or Color3.new(1, 0, 0)

    local Title = Instance.new("TextLabel", MainFrame)
    Title.Text = "Made by Ann"
    Title.Size = UDim2.new(1, 0, 0.4, 0)
    Title.BackgroundTransparency = 1
    Title.TextColor3 = Color3.new(1, 1, 1)
    Title.Font = Enum.Font.FredokaOne
    Title.TextSize = 20

    -- Label cho Auto Farm (G)
    StatusLabel_G = Instance.new("TextLabel", MainFrame)
    StatusLabel_G.Size = UDim2.new(1, 0, 0.3, 0)
    StatusLabel_G.Position = UDim2.new(0, 0, 0.4, 0)
    StatusLabel_G.BackgroundTransparency = 1
    StatusLabel_G.Font = Enum.Font.SourceSansBold
    StatusLabel_G.TextSize = 16
    
    if getgenv().Toggle_G then
        StatusLabel_G.Text = "[G] Auto Farm: ON"
        StatusLabel_G.TextColor3 = Color3.new(0, 1, 0)
    else
        StatusLabel_G.Text = "[G] Auto Farm: OFF"
        StatusLabel_G.TextColor3 = Color3.new(1, 0, 0)
    end

    -- Label cho Auto Next Stage (H)
    StatusLabel_H = Instance.new("TextLabel", MainFrame)
    StatusLabel_H.Size = UDim2.new(1, 0, 0.3, 0)
    StatusLabel_H.Position = UDim2.new(0, 0, 0.7, 0)
    StatusLabel_H.BackgroundTransparency = 1
    StatusLabel_H.Font = Enum.Font.SourceSansBold
    StatusLabel_H.TextSize = 16

    if getgenv().Toggle_H then
        StatusLabel_H.Text = "[H] Auto Next Stage: ON"
        StatusLabel_H.TextColor3 = Color3.new(0, 1, 0)
    else
        StatusLabel_H.Text = "[H] Auto Next Stage: OFF"
        StatusLabel_H.TextColor3 = Color3.new(1, 0, 0)
    end

    makeDraggable(MainFrame)
end

LocalPlayer.CharacterAdded:Connect(function() task.wait(1); CreateToggleUI() end)
CreateToggleUI()

-- ==============================================================================
--                            XỬ LÝ PHÍM TẮT (INPUT)
-- ==============================================================================
UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end

    if input.KeyCode == Enum.KeyCode.G then
        getgenv().Toggle_G = not getgenv().Toggle_G
        local color = getgenv().Toggle_G and Color3.new(0, 1, 0) or Color3.new(1, 0, 0)
        if StatusLabel_G then
            StatusLabel_G.Text = "[G] Auto Farm: " .. (getgenv().Toggle_G and "ON" or "OFF")
            StatusLabel_G.TextColor3 = color
        end
        if UIStroke then
            UIStroke.Color = color
        end
    end

    if input.KeyCode == Enum.KeyCode.H then
        getgenv().Toggle_H = not getgenv().Toggle_H
        local color = getgenv().Toggle_H and Color3.new(0, 1, 0) or Color3.new(1, 0, 0)
        if StatusLabel_H then
            StatusLabel_H.Text = "[H] Auto Next Stage: " .. (getgenv().Toggle_H and "ON" or "OFF")
            StatusLabel_H.TextColor3 = color
        end
    end
end)

-- ==============================================================================
--                            VÒNG LẶP FARM (MAIN LOOP)
-- ==============================================================================
while task.wait(0.2) do
    if getgenv().Toggle_G then
        runKillAura()
        
        if isTeleportingActive then
            local mob = getNearestMob()
            if mob and mob.Name == LastMobName then
                tweenBehind(mob)
            else
                isTeleportingActive = false
                LastMobName = nil
            end
        else
            local mob = getNearestMob()
            if mob and mob.Name ~= LastMobName then
                isTeleportingActive = true
                tweenBehind(mob)
                LastMobName = mob.Name 
                
                task.spawn(function()
                    -- Giai đoạn 1: Chờ 3.0 giây sau khi dịch chuyển
                    local startTime = tick()
                    while tick() - startTime < SKILL_DELAY do
                        if not isTeleportingActive or not getgenv().Toggle_G then return end
                        task.wait(0.1)
                    end

                    -- Giai đoạn 2: Dùng Skill
                    if getgenv().Toggle_G then activateSpinningLariat() end
                    
                    -- Giai đoạn 3: Chờ hết chu kỳ (4.0 - 3.0 = 1.0 giây)
                    local remaining = RUN_DURATION - SKILL_DELAY
                    if remaining > 0 then
                        task.wait(remaining)
                    end
                    
                    isTeleportingActive = false 
                end)
            end
        end
    end
end
